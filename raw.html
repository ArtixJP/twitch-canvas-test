<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://esm.sh https://esm.run https://cdn.tailwindcss.com https://threejs.org https://cdn.threejs.org https://cdn.p5js.org https://code.jquery.com https://d3js.org https://cdn.plot.ly https://cdn.tonejs.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: https:; media-src 'self' https:; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; worker-src 'self'; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://player.vimeo.com; connect-src 'self' https: wss: ws:; object-src 'none'; base-uri 'self'; form-action 'self';">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Twitch Versus Code - Super Mario Voxel World</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
        @keyframes pop {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1.5); }
        }
        body { 
            font-family: system-ui, sans-serif; 
            margin: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, #0a0a2e 0%, #1a1a4e 50%, #5c94fc 100%);
            color: white;
        }
        #game-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #ui-overlay { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; text-align: center; pointer-events: none; }
        #crosshair { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; z-index: 100; }
        .block-icon[data-type="question"] { display: flex; align-items: center; justify-content: center; font-weight: bold; color: #8B4513; font-size: 20px; }
        #instructions { position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; font-size: 14px; z-index: 100; max-width: 350px; }
        #instructions strong { color: #ffd700; }
        #block-selector { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; z-index: 100; display: flex; gap: 10px; }
        .block-icon { width: 40px; height: 40px; border: 2px solid white; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
        .block-icon.selected { border-color: gold; transform: scale(1.2); }
        .block-icon:hover { transform: scale(1.1); }
        h1 { font-size: 3rem; text-align: center; }
    </style>
</head>
<body>
<div id="game-container"></div>
<div id="ui-overlay"><h1 style="color: #e52521; text-shadow: 4px 4px 0 #fbd000, -2px -2px 0 #000; font-family: 'Impact', sans-serif;">üçÑ Super Mario Voxel World üçÑ</h1><h2 style="color: #fff; text-shadow: 0 0 10px #00ffff, 0 0 20px #ff00ff; font-family: 'Impact', sans-serif; margin-top: -10px;">üöÄ SPACE EXPLORATION MODE üåå</h2></div>
<div id="crosshair">+</div>
<div id="instructions">WASD: Move | Space: Jump | Left Click: Break | Right Click: Place | <strong>M: Place Block (works anytime!)</strong> | 1-7: Select Block | Click to start</div>
<div id="block-selector">
<div class="block-icon selected" data-type="grass" style="background: #4a7c23;" title="Grass"></div>
<div class="block-icon" data-type="dirt" style="background: #8b4513;" title="Dirt"></div>
<div class="block-icon" data-type="stone" style="background: #808080;" title="Stone"></div>
<div class="block-icon" data-type="wood" style="background: #8B5A2B;" title="Wood"></div>
<div class="block-icon" data-type="sand" style="background: #f4d03f;" title="Sand"></div>
<div class="block-icon" data-type="water" style="background: #3498db;" title="Water"></div>
<div class="block-icon" data-type="brick" style="background: #c0392b;" title="Brick"></div>
<div class="block-icon" data-type="question" style="background: #ffd700;" title="? Block">?</div>
<div class="block-icon" data-type="pipe" style="background: #00aa00;" title="Pipe"></div>
<div class="block-icon" data-type="moon" style="background: #cccccc;" title="Moon Rock">üåô</div>
<div class="block-icon" data-type="star" style="background: #ffff00;" title="Star Block">‚≠ê</div>
<div class="block-icon" data-type="nebula" style="background: linear-gradient(45deg, #ff00ff, #00ffff);" title="Nebula">üåå</div>
<div class="block-icon" data-type="mom" style="background: linear-gradient(45deg, #ff69b4, #ff1493);" title="Hi Mom Block">üíï</div>
</div>
<script>
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a2e);
    scene.fog = new THREE.Fog(0x0a0a2e, 30, 80);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.getElementById('game-container').appendChild(renderer.domElement);
    
    const blocks = new Map();
    const blockSize = 1;
    const textures = {
        grass: new THREE.MeshLambertMaterial({color: 0x4a7c23}),
        dirt: new THREE.MeshLambertMaterial({color: 0x8b4513}),
        stone: new THREE.MeshLambertMaterial({color: 0x808080}),
        wood: new THREE.MeshLambertMaterial({color: 0x8B5A2B}),
        sand: new THREE.MeshLambertMaterial({color: 0xf4d03f}),
        water: new THREE.MeshLambertMaterial({color: 0x3498db, transparent: true, opacity: 0.7}),
        brick: new THREE.MeshLambertMaterial({color: 0xc0392b}),
        question: new THREE.MeshLambertMaterial({color: 0xffd700}),
        pipe: new THREE.MeshLambertMaterial({color: 0x00aa00}),
        moon: new THREE.MeshLambertMaterial({color: 0xcccccc}),
        star: new THREE.MeshLambertMaterial({color: 0xffff00, emissive: 0xffff00, emissiveIntensity: 0.5}),
        nebula: new THREE.MeshLambertMaterial({color: 0xff00ff, transparent: true, opacity: 0.6}),
        mom: new THREE.MeshLambertMaterial({color: 0xff69b4, emissive: 0xff1493, emissiveIntensity: 0.3}),
        marioRed: new THREE.MeshLambertMaterial({color: 0xe52521})
    };
    
    function createBlock(x, y, z, type='grass') {
        const geo = new THREE.BoxGeometry(blockSize, blockSize, blockSize);
        const block = new THREE.Mesh(geo, textures[type]);
        block.position.set(x, y, z);
        block.castShadow = true;
        block.receiveShadow = true;
        scene.add(block);
        blocks.set(`${x},${y},${z}`, block);
        return block;
    }
    
    for(let x = -15; x < 15; x++) {
        for(let z = -15; z < 15; z++) {
            const h = Math.floor(Math.sin(x*0.3)*Math.cos(z*0.3)*2 + 2);
            for(let y = 0; y <= h; y++) {
                createBlock(x, y, z, y === h ? 'grass' : y > h-2 ? 'dirt' : 'stone');
            }
        }
    }
    
    const sun = new THREE.DirectionalLight(0xffffff, 1);
    sun.position.set(10, 20, 10);
    sun.castShadow = true;
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0x404060));
    
    // Add space point lights for stars effect
    const starLight1 = new THREE.PointLight(0x00ffff, 0.5, 50);
    starLight1.position.set(10, 20, 10);
    scene.add(starLight1);
    const starLight2 = new THREE.PointLight(0xff00ff, 0.5, 50);
    starLight2.position.set(-10, 25, -10);
    scene.add(starLight2);
    
    // Add Mario-style question blocks floating in the air
    for(let i = -5; i <= 5; i += 3) {
        createBlock(i, 6, 0, 'question');
    }
    // Add green pipes
    for(let py = 0; py <= 3; py++) {
        createBlock(8, py, 8, 'pipe');
        createBlock(-8, py, -8, 'pipe');
    }
    
    // Add floating star blocks in space
    for(let i = 0; i < 20; i++) {
        const sx = Math.floor(Math.random() * 30 - 15);
        const sy = Math.floor(Math.random() * 10 + 12);
        const sz = Math.floor(Math.random() * 30 - 15);
        createBlock(sx, sy, sz, 'star');
    }
    // Add "hi mom" floating text blocks
    const hiMomText = ['H','I',' ','M','O','M'];
    for(let i = 0; i < 6; i++) {
        if(hiMomText[i] !== ' ') createBlock(-3 + i, 20, -5, 'mom');
    }
    // Create 3D text sprite for "hi mom"
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 128;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ff69b4';
    ctx.fillRect(0, 0, 512, 128);
    ctx.font = 'bold 80px Impact';
    ctx.fillStyle = '#ffffff';
    ctx.strokeStyle = '#ff1493';
    ctx.lineWidth = 4;
    ctx.textAlign = 'center';
    ctx.strokeText('HI MOM! üíï', 256, 90);
    ctx.fillText('HI MOM! üíï', 256, 90);
    const texture = new THREE.CanvasTexture(canvas);
    const spriteMat = new THREE.SpriteMaterial({map: texture});
    const sprite = new THREE.Sprite(spriteMat);
    sprite.scale.set(8, 2, 1);
    sprite.position.set(0, 22, -5);
    scene.add(sprite);
    
    // Add moon platform
    for(let mx = -3; mx <= 3; mx++) {
        for(let mz = -3; mz <= 3; mz++) {
            if(Math.abs(mx) + Math.abs(mz) <= 4) createBlock(mx, 15, mz, 'moon');
        }
    }
    
    const player = {x: 0, y: 10, z: 5, vx: 0, vy: 0, vz: 0, yaw: 0, pitch: 0, grounded: false};
    let selectedBlock = 'grass';
    
    document.querySelectorAll('.block-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            document.querySelectorAll('.block-icon').forEach(i => i.classList.remove('selected'));
            icon.classList.add('selected');
            selectedBlock = icon.dataset.type;
        });
    });
    const keys = {};
    
    document.addEventListener('keydown', e => {
        keys[e.code] = true;
        if(e.code >= 'Digit1' && e.code <= 'Digit7') {
            const types = ['grass', 'dirt', 'stone', 'wood', 'sand', 'water', 'brick', 'question', 'pipe'];
            const idx = parseInt(e.code.replace('Digit', '')) - 1;
            if(types[idx]) {
                selectedBlock = types[idx];
                document.querySelectorAll('.block-icon').forEach(i => i.classList.remove('selected'));
                document.querySelector(`[data-type="${selectedBlock}"]`).classList.add('selected');
            }
        }
        if(e.code === 'KeyM' || e.key.toLowerCase() === 'm') {
            placeBlockAnywhere();
        }
    });
    document.addEventListener('keyup', e => keys[e.code] = false);
    document.addEventListener('click', () => document.body.requestPointerLock());
    document.addEventListener('mousemove', e => {
        if(document.pointerLockElement) {
            player.yaw -= e.movementX * 0.002;
            player.pitch -= e.movementY * 0.002;
            player.pitch = Math.max(-1.5, Math.min(1.5, player.pitch));
        }
    });
    
    const raycaster = new THREE.Raycaster();
    
    function placeBlockAnywhere() {
        // Place block in front of player even without pointer lock
        const direction = new THREE.Vector3();
        camera.getWorldDirection(direction);
        const newX = Math.round(player.x + direction.x * 3);
        const newY = Math.round(player.y + direction.y * 3);
        const newZ = Math.round(player.z + direction.z * 3);
        if(!blocks.has(`${newX},${newY},${newZ}`)) {
            createBlock(newX, newY, newZ, selectedBlock);
            showPlaceEffect(newX, newY, newZ);
        }
    }
    
    function showPlaceEffect(x, y, z) {
        const flash = document.createElement('div');
        flash.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#ffd700;font-size:24px;font-weight:bold;z-index:200;animation:pop 0.5s ease-out forwards;pointer-events:none;';
        flash.textContent = '‚ú® Block Placed! ‚ú®';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 500);
    }
    
    function placeBlock() {
        if(!document.pointerLockElement) return;
        const direction = new THREE.Vector3();
        camera.getWorldDirection(direction);
        raycaster.set(camera.position, direction);
        const meshes = Array.from(blocks.values());
        const hits = raycaster.intersectObjects(meshes);
        if(hits.length > 0 && hits[0].distance < 6) {
            const n = hits[0].face.normal;
            const p = hits[0].object.position;
            const newX = Math.round(p.x + n.x);
            const newY = Math.round(p.y + n.y);
            const newZ = Math.round(p.z + n.z);
            if(!blocks.has(`${newX},${newY},${newZ}`)) {
                createBlock(newX, newY, newZ, selectedBlock);
            }
        }
    }
    document.addEventListener('mousedown', e => {
        if(!document.pointerLockElement) return;
        const direction = new THREE.Vector3();
        camera.getWorldDirection(direction);
        raycaster.set(camera.position, direction);
        const meshes = Array.from(blocks.values());
        const hits = raycaster.intersectObjects(meshes);
        if(hits.length > 0 && hits[0].distance < 6) {
            if(e.button === 0) {
                const p = hits[0].object.position;
                blocks.delete(`${p.x},${p.y},${p.z}`);
                scene.remove(hits[0].object);
            } else if(e.button === 2) {
                const n = hits[0].face.normal;
                const p = hits[0].object.position;
                const newX = Math.round(p.x + n.x);
                const newY = Math.round(p.y + n.y);
                const newZ = Math.round(p.z + n.z);
                if(!blocks.has(`${newX},${newY},${newZ}`)) {
                    createBlock(newX, newY, newZ, selectedBlock);
                }
            }
        }
    });
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    function update() {
        const speed = 0.1, friction = 0.85;
        const dir = {x: Math.sin(player.yaw), z: Math.cos(player.yaw)};
        if(keys['KeyW']) { player.vx += dir.x*speed; player.vz += dir.z*speed; }
        if(keys['KeyS']) { player.vx -= dir.x*speed; player.vz -= dir.z*speed; }
        if(keys['KeyA']) { player.vx += dir.z*speed; player.vz -= dir.x*speed; }
        if(keys['KeyD']) { player.vx -= dir.z*speed; player.vz += dir.x*speed; }
        if(keys['Space'] && player.grounded) player.vy = 0.2;
        
        player.vy -= 0.01;
        player.vx *= friction; player.vz *= friction;
        player.x += player.vx; player.y += player.vy; player.z += player.vz;
        
        player.grounded = false;
        const feetY = Math.floor(player.y - 1.6);
        const feet = `${Math.round(player.x)},${feetY},${Math.round(player.z)}`;
        if(blocks.has(feet) && player.vy <= 0) {
            const targetY = feetY + 2.6;
            if(player.y < targetY + 0.1) {
                player.y = targetY;
                player.vy = 0;
                player.grounded = true;
            }
        }
        if(player.y < -10) { player.x = 0; player.y = 10; player.z = 5; player.vy = 0; }
        
        camera.position.lerp(new THREE.Vector3(player.x, player.y, player.z), 0.5);
        camera.rotation.order = 'YXZ';
        camera.rotation.y = player.yaw;
        camera.rotation.x = player.pitch;
    }
    
    function animate() {
        requestAnimationFrame(animate);
        update();
        renderer.render(scene, camera);
    }
    animate();
    
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
    </script>
</body>
</html>