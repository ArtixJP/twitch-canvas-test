<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Pokemon Adventure - JSGL Game</title>
<style>* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Press Start 2P', system-ui, sans-serif;
  background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
  min-height: 100vh;
  overflow: hidden;
}

#game-container {
  position: relative;
  width: 100vw;
  height: 100vh;
}

#game-canvas {
  display: block;
  background: linear-gradient(180deg, #87CEEB 0%, #90EE90 60%, #228B22 100%);
  image-rendering: pixelated;
}

.ui-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  pointer-events: none;
  z-index: 100;
}

.stats-panel {
  background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(30,30,60,0.9));
  border: 4px solid #FFD700;
  border-radius: 15px;
  padding: 15px;
  color: white;
  font-size: 12px;
  box-shadow: 0 0 20px rgba(255,215,0,0.5);
  pointer-events: auto;
}

.stats-panel h3 {
  color: #FFD700;
  margin-bottom: 10px;
  text-shadow: 2px 2px #000;
}

.stat-row {
  display: flex;
  align-items: center;
  margin: 8px 0;
  gap: 10px;
}

.stat-icon {
  font-size: 20px;
}

.pokeballs-display {
  display: flex;
  gap: 5px;
}

.pokeball-icon {
  font-size: 18px;
  transition: transform 0.2s;
}

.pokeball-icon:hover {
  transform: scale(1.3);
}

.caught-pokemon {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  max-width: 200px;
}

.caught-pokemon span {
  font-size: 24px;
  animation: bounce 1s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.controls-panel {
  background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(60,30,30,0.9));
  border: 4px solid #FF6B6B;
  border-radius: 15px;
  padding: 15px;
  color: white;
  font-size: 10px;
  pointer-events: auto;
}

.controls-panel h3 {
  color: #FF6B6B;
  margin-bottom: 10px;
}

.key {
  display: inline-block;
  background: #333;
  border: 2px solid #666;
  border-radius: 5px;
  padding: 3px 8px;
  margin: 2px;
  font-size: 10px;
}

.message-box {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  border: 4px solid #4CAF50;
  border-radius: 15px;
  padding: 20px 40px;
  color: white;
  font-size: 16px;
  text-align: center;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 200;
}

.message-box.show {
  opacity: 1;
}

.catch-animation {
  position: absolute;
  font-size: 60px;
  pointer-events: none;
  z-index: 150;
  animation: catchAnim 1s ease-out forwards;
}

@keyframes catchAnim {
  0% { transform: scale(1) rotate(0deg); opacity: 1; }
  50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
  100% { transform: scale(0) rotate(360deg); opacity: 0; }
}

.wild-appear {
  position: absolute;
  font-size: 24px;
  color: #FFD700;
  text-shadow: 2px 2px #000;
  pointer-events: none;
  z-index: 150;
  animation: wildAppear 2s ease-out forwards;
}

@keyframes wildAppear {
  0% { transform: scale(0); opacity: 0; }
  20% { transform: scale(1.2); opacity: 1; }
  80% { transform: scale(1); opacity: 1; }
  100% { transform: translateY(-50px); opacity: 0; }
}

.battle-flash {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  opacity: 0;
  pointer-events: none;
  z-index: 300;
}

.battle-flash.active {
  animation: battleFlash 0.5s ease-out;
}

@keyframes battleFlash {
  0% { opacity: 0.8; }
  100% { opacity: 0; }
}

.title-screen {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 500;
  transition: opacity 0.5s;
}

.title-screen.hidden {
  opacity: 0;
  pointer-events: none;
}

.game-title {
  font-size: 48px;
  color: #FFD700;
  text-shadow: 4px 4px #FF6B6B, 8px 8px #000;
  margin-bottom: 20px;
  animation: titlePulse 2s ease-in-out infinite;
}

@keyframes titlePulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.title-pokemon {
  font-size: 80px;
  margin: 20px;
  display: flex;
  gap: 20px;
}

.title-pokemon span {
  animation: titleBounce 1s ease-in-out infinite;
}

.title-pokemon span:nth-child(2) { animation-delay: 0.2s; }
.title-pokemon span:nth-child(3) { animation-delay: 0.4s; }
.title-pokemon span:nth-child(4) { animation-delay: 0.6s; }

@keyframes titleBounce {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(10deg); }
}

.start-btn {
  background: linear-gradient(135deg, #FF6B6B, #FF8E53);
  border: 4px solid #FFD700;
  border-radius: 30px;
  padding: 20px 60px;
  font-size: 24px;
  color: white;
  cursor: pointer;
  margin-top: 40px;
  transition: all 0.3s;
  font-family: inherit;
}

.start-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 30px rgba(255,107,107,0.8);
}

.subtitle {
  color: #aaa;
  font-size: 14px;
  margin-top: 20px;
}

/* BATTLE SCREEN STYLES */
#battle-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, #1a1a2e 0%, #2d3436 100%);
  z-index: 400;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

#battle-screen.active {
  display: flex;
  animation: battleEnter 0.5s ease-out;
}

@keyframes battleEnter {
  0% { transform: scale(0); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

.battle-arena {
  width: 90%;
  max-width: 800px;
  background: linear-gradient(180deg, #87CEEB 0%, #90EE90 70%, #228B22 100%);
  border: 8px solid #333;
  border-radius: 20px;
  padding: 30px;
  position: relative;
  min-height: 500px;
  display: flex;
  flex-direction: column;
}

.battle-trainer {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.battle-trainer.player {
  bottom: 180px;
  left: 50px;
}

.battle-trainer.opponent {
  top: 30px;
  right: 50px;
}

.trainer-pokemon {
  font-size: 80px;
  animation: pokemonIdle 1s ease-in-out infinite;
}

@keyframes pokemonIdle {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.hp-bar-container {
  width: 200px;
  background: #333;
  border-radius: 10px;
  padding: 5px;
  margin-top: 10px;
}

.hp-bar {
  height: 20px;
  background: linear-gradient(90deg, #4CAF50, #8BC34A);
  border-radius: 5px;
  transition: width 0.5s ease-out;
}

.hp-bar.low {
  background: linear-gradient(90deg, #f44336, #ff5722);
}

.hp-bar.medium {
  background: linear-gradient(90deg, #ff9800, #ffc107);
}

.trainer-name {
  color: white;
  font-size: 14px;
  text-shadow: 2px 2px #000;
  margin-top: 5px;
}

.battle-menu {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

.battle-btn {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: 3px solid #FFD700;
  border-radius: 15px;
  padding: 15px 25px;
  color: white;
  font-family: inherit;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.battle-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
}

.battle-btn.attack { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
.battle-btn.defend { background: linear-gradient(135deg, #4834d4, #686de0); }
.battle-btn.special { background: linear-gradient(135deg, #f9ca24, #f0932b); }
.battle-btn.run { background: linear-gradient(135deg, #636e72, #2d3436); }

.battle-log {
  position: absolute;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  border: 3px solid #4CAF50;
  border-radius: 10px;
  padding: 15px 30px;
  color: white;
  font-size: 14px;
  min-width: 400px;
  text-align: center;
}

.damage-number {
  position: absolute;
  font-size: 30px;
  font-weight: bold;
  color: #ff6b6b;
  text-shadow: 2px 2px #000;
  animation: damageFloat 1s ease-out forwards;
  pointer-events: none;
}

@keyframes damageFloat {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
}

.battle-vs {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 40px;
  color: #FFD700;
  text-shadow: 3px 3px #000;
  animation: vsPulse 1s ease-in-out infinite;
}

@keyframes vsPulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.2); }
}</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet"/>
</head>
<body>
<div id="game-container">
<canvas id="game-canvas"></canvas>
<div class="ui-overlay">
<div class="stats-panel">
<h3>üéÆ TRAINER STATS</h3>
<div class="stat-row">
<span class="stat-icon">‚≠ê</span>
<span>Score: <span id="score">0</span></span>
</div>
<div class="stat-row">
<span class="stat-icon">üéØ</span>
<span>Pokeballs:</span>
<div class="pokeballs-display" id="pokeballs"></div>
</div>
<div class="stat-row">
<span class="stat-icon">üì¶</span>
<span>Caught:</span>
</div>
<div class="caught-pokemon" id="caught-pokemon"></div>
</div>
<div class="controls-panel">
<h3>üïπÔ∏è CONTROLS</h3>
<p><span class="key">‚Üë</span><span class="key">‚Üì</span><span class="key">‚Üê</span><span class="key">‚Üí</span> Move</p>
<p><span class="key">SPACE</span> Throw Pokeball</p>
<p><span class="key">R</span> Run faster</p>
</div>
</div>
<div class="message-box" id="message-box"></div>
<div class="battle-flash" id="battle-flash"></div><div id="battle-screen">
<div class="battle-arena">
<div class="battle-trainer opponent">
<div class="trainer-pokemon" id="opponent-pokemon">üî•</div>
<div class="hp-bar-container">
<div class="hp-bar" id="opponent-hp" style="width: 100%"></div>
</div>
<div class="trainer-name" id="opponent-name">Rival Trainer</div>
</div>
<div class="battle-vs">‚öîÔ∏è VS ‚öîÔ∏è</div>
<div class="battle-trainer player">
<div class="trainer-pokemon" id="player-pokemon">‚ö°</div>
<div class="hp-bar-container">
<div class="hp-bar" id="player-hp" style="width: 100%"></div>
</div>
<div class="trainer-name">Your Pokemon</div>
</div>
</div>
<div class="battle-menu" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
<button class="battle-btn attack" onclick="battleAction('attack')">‚öîÔ∏è ATTACK</button>
<button class="battle-btn defend" onclick="battleAction('defend')">üõ°Ô∏è DEFEND</button>
<button class="battle-btn special" onclick="battleAction('special')">‚ú® SPECIAL</button>
<button class="battle-btn run" onclick="battleAction('run')">üèÉ RUN</button>
</div>
<div class="battle-log" id="battle-log" style="position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 3px solid #4CAF50; border-radius: 10px; padding: 15px 30px; color: white; font-size: 14px; min-width: 400px; text-align: center;">Choose your action!</div>
</div>
<div class="title-screen" id="title-screen">
<div class="game-title">üéÆ POKEMON CATCH!</div>
<div class="title-pokemon">
<span>‚ö°</span>
<span>üî•</span>
<span>üíß</span>
<span>üåø</span>
</div>
<p style="color: #FFD700; font-size: 16px;">Catch 'em all!</p>
<button class="start-btn" id="start-btn">‚ñ∂ START GAME</button>
<p class="subtitle">Move with arrow keys, SPACE to catch!</p>
</div>
</div>
<script>
// JSGL-style Pokemon Game Engine with BATTLE SYSTEM!
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');

// Set canvas size
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Game State
const game = {
  running: false,
  score: 0,
  pokeballs: 10,
  caughtPokemon: [],
  time: 0,
  inBattle: false
};

// Battle State
const battle = {
  active: false,
  playerHP: 100,
  playerMaxHP: 100,
  opponentHP: 100,
  opponentMaxHP: 100,
  playerPokemon: null,
  opponentPokemon: null,
  opponentTrainer: null,
  playerTurn: true,
  defending: false
};

// Pokemon types with their properties
const POKEMON_TYPES = [
  { emoji: '‚ö°', name: 'Pikachu', color: '#FFD700', speed: 3, points: 100, rarity: 0.3, attack: 25, defense: 15 },
  { emoji: 'üî•', name: 'Charmander', color: '#FF6B6B', speed: 2.5, points: 80, rarity: 0.35, attack: 22, defense: 18 },
  { emoji: 'üíß', name: 'Squirtle', color: '#4FC3F7', speed: 2, points: 70, rarity: 0.4, attack: 18, defense: 25 },
  { emoji: 'üåø', name: 'Bulbasaur', color: '#81C784', speed: 1.8, points: 60, rarity: 0.45, attack: 20, defense: 20 },
  { emoji: 'üêâ', name: 'Dragonite', color: '#9C27B0', speed: 4, points: 200, rarity: 0.1, attack: 35, defense: 25 },
  { emoji: 'üëª', name: 'Gengar', color: '#7B1FA2', speed: 3.5, points: 150, rarity: 0.15, attack: 30, defense: 15 },
  { emoji: 'ü¶ã', name: 'Butterfree', color: '#E1BEE7', speed: 2.8, points: 90, rarity: 0.25, attack: 15, defense: 12 },
  { emoji: 'üê¢', name: 'Blastoise', color: '#0288D1', speed: 1.5, points: 120, rarity: 0.2, attack: 28, defense: 30 },
  { emoji: 'ü¶Ö', name: 'Pidgeot', color: '#8D6E63', speed: 3.2, points: 85, rarity: 0.3, attack: 20, defense: 18 },
  { emoji: 'üåü', name: 'Starmie', color: '#00BCD4', speed: 2.2, points: 95, rarity: 0.25, attack: 22, defense: 22 }
];

// Opponent Trainers
const TRAINERS = [
  { emoji: 'üßë‚Äçü¶∞', name: 'Rival Gary', color: '#e74c3c' },
  { emoji: 'üë®‚Äçüî¨', name: 'Prof. Oak', color: '#9b59b6' },
  { emoji: 'üë©‚Äçüé§', name: 'Gym Leader', color: '#3498db' },
  { emoji: 'ü•∑', name: 'Team Rocket', color: '#2c3e50' },
  { emoji: 'üßô‚Äç‚ôÇÔ∏è', name: 'Elite Four', color: '#f39c12' }
];

// Player object
const player = {
  x: 0,
  y: 0,
  width: 50,
  height: 50,
  speed: 5,
  running: false,
  direction: 'down',
  frame: 0,
  emoji: 'üß¢'
};

// Wild Pokemon array
let wildPokemon = [];

// Opponent trainers on map
let opponentTrainers = [];

// Pokeballs in flight
let pokeballs = [];

// Particles for effects
let particles = [];

// Grass patches for environment
let grassPatches = [];

// Input handling
const keys = {};
window.addEventListener('keydown', (e) => {
  keys[e.code] = true;
  if (e.code === 'Space' && game.running && !game.inBattle) {
    e.preventDefault();
    throwPokeball();
  }
});
window.addEventListener('keyup', (e) => keys[e.code] = false);

// Initialize game
function initGame() {
  player.x = canvas.width / 2;
  player.y = canvas.height / 2;
  game.score = 0;
  game.pokeballs = 10;
  game.caughtPokemon = [];
  wildPokemon = [];
  opponentTrainers = [];
  pokeballs = [];
  particles = [];
  
  // Generate grass patches
  grassPatches = [];
  for (let i = 0; i < 50; i++) {
    grassPatches.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: 20 + Math.random() * 30
    });
  }
  
  // Spawn initial trainers
  for (let i = 0; i < 3; i++) {
    spawnTrainer();
  }
  
  updateUI();
}

// Spawn opponent trainer
function spawnTrainer() {
  const trainerType = TRAINERS[Math.floor(Math.random() * TRAINERS.length)];
  let x, y;
  do {
    x = Math.random() * (canvas.width - 100) + 50;
    y = Math.random() * (canvas.height - 100) + 50;
  } while (Math.hypot(x - player.x, y - player.y) < 250);
  
  const trainer = {
    ...trainerType,
    x, y,
    width: 60,
    height: 60,
    vx: (Math.random() - 0.5) * 1.5,
    vy: (Math.random() - 0.5) * 1.5,
    pokemon: POKEMON_TYPES[Math.floor(Math.random() * POKEMON_TYPES.length)],
    defeated: false
  };
  
  opponentTrainers.push(trainer);
}

// Check collision with trainers
function checkTrainerCollision() {
  if (game.inBattle) return;
  for (const trainer of opponentTrainers) {
    if (trainer.defeated) continue;
    const dist = Math.hypot(trainer.x - player.x, trainer.y - player.y);
    if (dist < 50) {
      startBattle(trainer);
      return;
    }
  }
}

// Start battle
function startBattle(trainer) {
  console.log('Starting battle with', trainer.name);
  game.inBattle = true;
  battle.active = true;
  battle.opponentTrainer = trainer;
  battle.opponentPokemon = {...trainer.pokemon};
  battle.playerPokemon = game.caughtPokemon.length > 0 
    ? {...POKEMON_TYPES.find(p => p.emoji === game.caughtPokemon[game.caughtPokemon.length - 1])} || {...POKEMON_TYPES[0]}
    : {...POKEMON_TYPES[0]};
  
  battle.playerHP = 100;
  battle.playerMaxHP = 100;
  battle.opponentHP = 100;
  battle.opponentMaxHP = 100;
  battle.playerTurn = true;
  battle.defending = false;
  
  // Show battle screen
  const battleScreen = document.getElementById('battle-screen');
  battleScreen.style.display = 'flex';
  battleScreen.classList.add('active');
  
  // Update battle UI
  document.getElementById('opponent-pokemon').textContent = battle.opponentPokemon.emoji;
  document.getElementById('player-pokemon').textContent = battle.playerPokemon.emoji;
  document.getElementById('opponent-name').textContent = trainer.name + "'s " + battle.opponentPokemon.name;
  document.getElementById('battle-log').textContent = trainer.name + " wants to battle!";
  
  updateBattleHP();
  
  // Flash effect
  const flash = document.getElementById('battle-flash');
  flash.classList.add('active');
  setTimeout(() => flash.classList.remove('active'), 500);
}

// Battle action - make it global
window.battleAction = function(action) {
  if (!battle.playerTurn || !battle.active) {
    console.log('Not player turn or battle not active');
    return;
  }
  
  console.log('Battle action:', action);
  
  let damage = 0;
  let message = '';
  
  switch(action) {
    case 'attack':
      damage = Math.floor(battle.playerPokemon.attack * (0.8 + Math.random() * 0.4));
      battle.opponentHP = Math.max(0, battle.opponentHP - damage);
      message = `${battle.playerPokemon.name} attacks! ${damage} damage!`;
      showDamage(damage, true);
      break;
    case 'defend':
      battle.defending = true;
      message = `${battle.playerPokemon.name} is defending!`;
      break;
    case 'special':
      if (Math.random() > 0.4) {
        damage = Math.floor(battle.playerPokemon.attack * 1.8);
        battle.opponentHP = Math.max(0, battle.opponentHP - damage);
        message = `CRITICAL HIT! ${damage} damage!`;
        showDamage(damage, true);
      } else {
        message = 'Special attack missed!';
      }
      break;
    case 'run':
      if (Math.random() > 0.3) {
        endBattle(false);
        return;
      } else {
        message = "Can't escape!";
      }
      break;
  }
  
  document.getElementById('battle-log').textContent = message;
  updateBattleHP();
  
  // Check win condition
  if (battle.opponentHP <= 0) {
    document.getElementById('battle-log').textContent = 'You won the battle!';
    setTimeout(() => endBattle(true), 1500);
    return;
  }
  
  // Opponent turn
  battle.playerTurn = false;
  setTimeout(opponentTurn, 1500);
}

// Opponent turn
function opponentTurn() {
  if (!battle.active) return;
  
  const actions = ['attack', 'attack', 'attack', 'special'];
  const action = actions[Math.floor(Math.random() * actions.length)];
  
  let damage = 0;
  let message = '';
  
  if (action === 'attack') {
    damage = Math.floor(battle.opponentPokemon.attack * (0.8 + Math.random() * 0.4));
    if (battle.defending) {
      damage = Math.floor(damage * 0.4);
      message = `${battle.opponentPokemon.name} attacks! Blocked! Only ${damage} damage!`;
    } else {
      message = `${battle.opponentPokemon.name} attacks! ${damage} damage!`;
    }
  } else {
    if (Math.random() > 0.5) {
      damage = Math.floor(battle.opponentPokemon.attack * 1.5);
      message = `${battle.opponentPokemon.name} uses special move! ${damage} damage!`;
    } else {
      message = `${battle.opponentPokemon.name}'s special attack missed!`;
    }
  }
  
  battle.playerHP = Math.max(0, battle.playerHP - damage);
  battle.defending = false;
  
  if (damage > 0) showDamage(damage, false);
  document.getElementById('battle-log').textContent = message;
  updateBattleHP();
  
  // Check lose condition
  if (battle.playerHP <= 0) {
    document.getElementById('battle-log').textContent = 'You lost the battle...';
    setTimeout(() => endBattle(false), 1500);
    return;
  }
  
  battle.playerTurn = true;
}

// Show damage number
function showDamage(damage, isOpponent) {
  const arena = document.querySelector('.battle-arena');
  const div = document.createElement('div');
  div.className = 'damage-number';
  div.textContent = '-' + damage;
  div.style.left = isOpponent ? '70%' : '30%';
  div.style.top = isOpponent ? '30%' : '70%';
  arena.appendChild(div);
  setTimeout(() => div.remove(), 1000);
}

// Update battle HP bars
function updateBattleHP() {
  const playerBar = document.getElementById('player-hp');
  const opponentBar = document.getElementById('opponent-hp');
  
  const playerPercent = (battle.playerHP / battle.playerMaxHP) * 100;
  const opponentPercent = (battle.opponentHP / battle.opponentMaxHP) * 100;
  
  playerBar.style.width = playerPercent + '%';
  opponentBar.style.width = opponentPercent + '%';
  
  playerBar.className = 'hp-bar' + (playerPercent < 25 ? ' low' : playerPercent < 50 ? ' medium' : '');
  opponentBar.className = 'hp-bar' + (opponentPercent < 25 ? ' low' : opponentPercent < 50 ? ' medium' : '');
}

// End battle
function endBattle(won) {
  console.log('Ending battle, won:', won);
  const battleScreen = document.getElementById('battle-screen');
  battleScreen.style.display = 'none';
  battleScreen.classList.remove('active');
  
  game.inBattle = false;
  battle.active = false;
  
  if (won) {
    const points = battle.opponentPokemon.points * 2;
    game.score += points;
    game.caughtPokemon.push(battle.opponentPokemon.emoji);
    battle.opponentTrainer.defeated = true;
    showMessage(`Victory! +${points} points! You caught ${battle.opponentPokemon.name}! üèÜ`);
    
    // Spawn new trainer
    setTimeout(spawnTrainer, 3000);
  } else {
    showMessage('Battle ended! üèÉ');
  }
  
  updateUI();
}

// Spawn wild Pokemon
function spawnPokemon() {
  if (wildPokemon.length >= 8) return;
  
  let selectedType;
  const roll = Math.random();
  let cumulative = 0;
  for (const type of POKEMON_TYPES) {
    cumulative += type.rarity;
    if (roll <= cumulative) {
      selectedType = type;
      break;
    }
  }
  if (!selectedType) selectedType = POKEMON_TYPES[0];
  
  let x, y;
  do {
    x = Math.random() * (canvas.width - 100) + 50;
    y = Math.random() * (canvas.height - 100) + 50;
  } while (Math.hypot(x - player.x, y - player.y) < 200);
  
  const pokemon = {
    ...selectedType,
    x, y,
    width: 60,
    height: 60,
    vx: (Math.random() - 0.5) * selectedType.speed,
    vy: (Math.random() - 0.5) * selectedType.speed,
    wobble: Math.random() * Math.PI * 2,
    caught: false
  };
  
  wildPokemon.push(pokemon);
  showWildAppear(pokemon);
}

function showWildAppear(pokemon) {
  const div = document.createElement('div');
  div.className = 'wild-appear';
  div.textContent = `Wild ${pokemon.name} appeared!`;
  div.style.left = pokemon.x + 'px';
  div.style.top = pokemon.y + 'px';
  document.getElementById('game-container').appendChild(div);
  setTimeout(() => div.remove(), 2000);
}

function throwPokeball() {
  if (game.pokeballs <= 0) {
    showMessage('No Pokeballs left! üò¢');
    return;
  }
  
  game.pokeballs--;
  updateUI();
  
  let nearest = null;
  let nearestDist = Infinity;
  
  for (const pokemon of wildPokemon) {
    if (pokemon.caught) continue;
    const dist = Math.hypot(pokemon.x - player.x, pokemon.y - player.y);
    if (dist < nearestDist && dist < 300) {
      nearestDist = dist;
      nearest = pokemon;
    }
  }
  
  const targetX = nearest ? nearest.x : player.x + (player.direction === 'right' ? 200 : player.direction === 'left' ? -200 : 0);
  const targetY = nearest ? nearest.y : player.y + (player.direction === 'down' ? 200 : player.direction === 'up' ? -200 : 0);
  
  pokeballs.push({
    x: player.x,
    y: player.y,
    targetX,
    targetY,
    target: nearest,
    speed: 12,
    rotation: 0
  });
}

function updatePokeballs() {
  for (let i = pokeballs.length - 1; i >= 0; i--) {
    const ball = pokeballs[i];
    
    const dx = ball.targetX - ball.x;
    const dy = ball.targetY - ball.y;
    const dist = Math.hypot(dx, dy);
    
    if (dist < 10) {
      if (ball.target && !ball.target.caught) {
        catchPokemon(ball.target);
      } else {
        createParticles(ball.x, ball.y, '#FF6B6B', 10);
      }
      pokeballs.splice(i, 1);
      continue;
    }
    
    ball.x += (dx / dist) * ball.speed;
    ball.y += (dy / dist) * ball.speed;
    ball.rotation += 0.3;
  }
}

function catchPokemon(pokemon) {
  pokemon.caught = true;
  game.score += pokemon.points;
  game.caughtPokemon.push(pokemon.emoji);
  
  document.getElementById('battle-flash').classList.add('active');
  setTimeout(() => document.getElementById('battle-flash').classList.remove('active'), 500);
  
  const div = document.createElement('div');
  div.className = 'catch-animation';
  div.textContent = 'üî¥';
  div.style.left = pokemon.x + 'px';
  div.style.top = pokemon.y + 'px';
  document.getElementById('game-container').appendChild(div);
  setTimeout(() => div.remove(), 1000);
  
  createParticles(pokemon.x, pokemon.y, pokemon.color, 30);
  showMessage(`Caught ${pokemon.name}! +${pokemon.points} points! üéâ`);
  
  setTimeout(() => {
    const idx = wildPokemon.indexOf(pokemon);
    if (idx > -1) wildPokemon.splice(idx, 1);
  }, 500);
  
  if (Math.random() < 0.3) {
    game.pokeballs++;
    showMessage('Bonus Pokeball! üéÅ');
  }
  
  updateUI();
}

function createParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    particles.push({
      x, y,
      vx: (Math.random() - 0.5) * 10,
      vy: (Math.random() - 0.5) * 10,
      life: 1,
      color,
      size: 5 + Math.random() * 10
    });
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.2;
    p.life -= 0.02;
    if (p.life <= 0) particles.splice(i, 1);
  }
}

function updatePlayer() {
  if (game.inBattle) return;
  
  player.running = keys['KeyR'];
  const speed = player.running ? player.speed * 1.8 : player.speed;
  
  let moving = false;
  
  if (keys['ArrowUp'] || keys['KeyW']) { player.y -= speed; player.direction = 'up'; moving = true; }
  if (keys['ArrowDown'] || keys['KeyS']) { player.y += speed; player.direction = 'down'; moving = true; }
  if (keys['ArrowLeft'] || keys['KeyA']) { player.x -= speed; player.direction = 'left'; moving = true; }
  if (keys['ArrowRight'] || keys['KeyD']) { player.x += speed; player.direction = 'right'; moving = true; }
  
  player.x = Math.max(25, Math.min(canvas.width - 25, player.x));
  player.y = Math.max(25, Math.min(canvas.height - 25, player.y));
  
  if (moving) player.frame += 0.2;
  
  checkTrainerCollision();
}

function updateWildPokemon() {
  for (const pokemon of wildPokemon) {
    if (pokemon.caught) continue;
    pokemon.wobble += 0.1;
    pokemon.x += pokemon.vx;
    pokemon.y += pokemon.vy;
    if (pokemon.x < 30 || pokemon.x > canvas.width - 30) pokemon.vx *= -1;
    if (pokemon.y < 30 || pokemon.y > canvas.height - 30) pokemon.vy *= -1;
    if (Math.random() < 0.01) {
      pokemon.vx = (Math.random() - 0.5) * pokemon.speed * 2;
      pokemon.vy = (Math.random() - 0.5) * pokemon.speed * 2;
    }
    const distToPlayer = Math.hypot(pokemon.x - player.x, pokemon.y - player.y);
    if (distToPlayer < 100) {
      const angle = Math.atan2(pokemon.y - player.y, pokemon.x - player.x);
      pokemon.vx = Math.cos(angle) * pokemon.speed * 1.5;
      pokemon.vy = Math.sin(angle) * pokemon.speed * 1.5;
    }
  }
}

function updateTrainers() {
  for (const trainer of opponentTrainers) {
    if (trainer.defeated) continue;
    trainer.x += trainer.vx;
    trainer.y += trainer.vy;
    if (trainer.x < 30 || trainer.x > canvas.width - 30) trainer.vx *= -1;
    if (trainer.y < 30 || trainer.y > canvas.height - 30) trainer.vy *= -1;
    if (Math.random() < 0.01) {
      trainer.vx = (Math.random() - 0.5) * 2;
      trainer.vy = (Math.random() - 0.5) * 2;
    }
  }
}

function draw() {
  ctx.fillStyle = '#90EE90';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.fillStyle = '#228B22';
  for (const grass of grassPatches) {
    ctx.beginPath();
    ctx.arc(grass.x, grass.y, grass.size, 0, Math.PI * 2);
    ctx.fill();
  }
  
  ctx.strokeStyle = 'rgba(0,100,0,0.2)';
  ctx.lineWidth = 1;
  for (let x = 0; x < canvas.width; x += 50) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
  }
  for (let y = 0; y < canvas.height; y += 50) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
  }
  
  // Draw opponent trainers
  for (const trainer of opponentTrainers) {
    if (trainer.defeated) continue;
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(trainer.x, trainer.y + 35, 25, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.shadowColor = trainer.color;
    ctx.shadowBlur = 20;
    ctx.font = '50px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(trainer.emoji, trainer.x, trainer.y);
    ctx.shadowBlur = 0;
    
    // Trainer label
    ctx.font = '12px "Press Start 2P", sans-serif';
    ctx.fillStyle = '#fff';
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 3;
    ctx.strokeText('‚öîÔ∏è ' + trainer.name, trainer.x, trainer.y - 40);
    ctx.fillText('‚öîÔ∏è ' + trainer.name, trainer.x, trainer.y - 40);
  }
  
  // Draw wild Pokemon
  for (const pokemon of wildPokemon) {
    if (pokemon.caught) continue;
    const wobbleOffset = Math.sin(pokemon.wobble) * 5;
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(pokemon.x, pokemon.y + 35, 25, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowColor = pokemon.color;
    ctx.shadowBlur = 20;
    ctx.font = '50px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(pokemon.emoji, pokemon.x, pokemon.y + wobbleOffset);
    ctx.shadowBlur = 0;
  }
  
  // Draw player
  ctx.shadowColor = '#FFD700';
  ctx.shadowBlur = player.running ? 30 : 15;
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.beginPath();
  ctx.ellipse(player.x, player.y + 30, 20, 8, 0, 0, Math.PI * 2);
  ctx.fill();
  const bounce = Math.sin(player.frame) * 3;
  ctx.font = '45px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(player.emoji, player.x, player.y + bounce);
  ctx.shadowBlur = 0;
  
  // Draw pokeballs in flight
  for (const ball of pokeballs) {
    ctx.save();
    ctx.translate(ball.x, ball.y);
    ctx.rotate(ball.rotation);
    ctx.font = '30px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('üî¥', 0, 0);
    ctx.restore();
  }
  
  // Draw particles
  for (const p of particles) {
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function updateUI() {
  document.getElementById('score').textContent = game.score;
  
  const pokeballsDiv = document.getElementById('pokeballs');
  pokeballsDiv.innerHTML = '';
  for (let i = 0; i < Math.min(game.pokeballs, 15); i++) {
    const span = document.createElement('span');
    span.className = 'pokeball-icon';
    span.textContent = 'üî¥';
    pokeballsDiv.appendChild(span);
  }
  if (game.pokeballs > 15) pokeballsDiv.innerHTML += `+${game.pokeballs - 15}`;
  
  const caughtDiv = document.getElementById('caught-pokemon');
  caughtDiv.innerHTML = '';
  for (const emoji of game.caughtPokemon.slice(-10)) {
    const span = document.createElement('span');
    span.textContent = emoji;
    caughtDiv.appendChild(span);
  }
}

function showMessage(text) {
  const box = document.getElementById('message-box');
  box.textContent = text;
  box.classList.add('show');
  setTimeout(() => box.classList.remove('show'), 2000);
}

function gameLoop() {
  if (!game.running) {
    requestAnimationFrame(gameLoop);
    return;
  }
  
  // Always update and draw the world, even during battle
  game.time++;
  
  if (!game.inBattle) {
    if (game.time % 180 === 0) spawnPokemon();
    if (game.time % 600 === 0 && game.pokeballs < 15) {
      game.pokeballs++;
      showMessage('New Pokeball! üéÅ');
      updateUI();
    }
    if (game.time % 900 === 0 && opponentTrainers.filter(t => !t.defeated).length < 3) {
      spawnTrainer();
    }
    
    updatePlayer();
    updateWildPokemon();
    updateTrainers();
    updatePokeballs();
    updateParticles();
  }
  
  draw();
  
  requestAnimationFrame(gameLoop);
}

document.getElementById('start-btn').addEventListener('click', () => {
  document.getElementById('title-screen').classList.add('hidden');
  initGame();
  game.running = true;
  for (let i = 0; i < 4; i++) {
    setTimeout(() => spawnPokemon(), i * 500);
  }
});

// Hide battle screen initially
document.getElementById('battle-screen').style.display = 'none';

gameLoop();
</script>
</body>
</html>